---
title: "data-query"
output: html_document
date: "2024-09-07"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  warning = FALSE, # show warnings
  message = FALSE, # show messages
  error = TRUE, # do not interrupt generation in case of errors,
  echo = TRUE  # show R code
)
```


```{r}
library(tidyverse) 
library(dplyr)
library(sf) 
library(terra)
library(raster)
library(arrow)
```

```{r}
obis_snapshot <- "obis_20240625.parquet"
```

```{r}
db <- open_dataset(obis_snapshot)
```

```{r}
obis_bathymetry <- db |>
  filter(flags == "{}") |> 
  mutate(bath_obs_prop_min = minimumDepthInMeters/bathymetry) |>
  mutate(bath_obs_prop_max = maximumDepthInMeters/bathymetry) |>
  filter(bath_obs_prop_min > 0) |>
  filter(bath_obs_prop_min <1) |>
  filter(bath_obs_prop_max > 0) |>
  filter(bath_obs_prop_max <1) |>
  mutate(bathymetry = round(as.numeric(bathymetry),0),
         minimumDepthInMeters = round(as.numeric(minimumDepthInMeters),0)) |>
  group_by(bathymetry, minimumDepthInMeters, bath_obs_prop_min, bath_obs_prop_max) |>
  count() |> 
  collect()
```

```{r}
obis_bathymetry |> 
  filter(bath_obs_prop_min != Inf) |>
  ggplot(aes(x = bath_obs_prop_min, weight = n)) +
  geom_histogram(binwidth = 0.02) +
  labs(x = "min_depth prop", y = "Weighted Count") +
  theme_minimal()
```

```{r}
obis_bathymetry |> 
  filter(bath_obs_prop_max != Inf) |>
  ggplot(aes(x = bath_obs_prop_max, weight = n)) +
  geom_histogram(binwidth = 0.02) +
  labs(x = "min_depth prop", y = "Weighted Count") +
  theme_minimal()
```

```{r}
obis_bathymetry |> 
  ggplot(aes(x = minimumDepthInMeters, weight = n)) +
  geom_histogram(binwidth = 200) +
  labs(x = "Depth", y = "Weighted Count") +
  theme_minimal()
```

## rights holder
```{r}
obis_pub <- db |>
  group_by(rightsHolder) |>
  count() |> 
  collect()
```

## ID
```{r}
obis_pub <- db |>
  group_by(ownerInstitutionCode) |>
  count() |> 
  collect()
```

## Map 


```{r}
obis_map <- db |>
  mutate(latitude = round(decimalLatitude,2), 
         longitude = round(decimalLongitude,2)) |> 
  #filter(year >1800) |>
  count(longitude, latitude) |> 
  collect()
```

```{r}
df_spatial <- obis_map |> 
  dplyr::filter(!is.na(latitude), 
         !is.na(longitude)) |> 
  st_as_sf(coords = c("longitude", "latitude"), 
           crs = "+proj=robin +lon_0=0 +x_0=0 +y_0=0 +datum=WGS84 +units=m")
```

```{r}
library(raster)
ras_temp <-raster(xmn=-180, xmx=180, ymn=-90, ymx=90,
                  resolution=c(0.1,0.1), vals=NA)
global_plot_all <- rasterize(df_spatial, ras_temp, 
                         field = "n", fun='sum') 
#rm(df_spatial) #remove unnecessary data
rm(ras_temp) #remove unnecessary data
```

```{r global_plot, cache=TRUE}
crs <- "+proj=robin +lon_0=0 +x_0=0 +y_0=0 +datum=WGS84 +units=m" 
global_plot_all <- terra::rast(global_plot_all) 
global_plot <- global_plot_all * 1 # to deal with NAs in this dataset 
# reproject for viz
global_plot_r <- terra::project(global_plot, crs, mask=TRUE) 
# define color gradient
library(MetBrewer)
colors <- c("grey", met.brewer(name="Isfahan1",n=20,type="continuous"))
# take log for viz
terra::plot(log(global_plot_r,10), col = colors, axes = FALSE)
writeRaster(global_plot_r, "../data/panels/PanelA_data.tif", overwrite=TRUE)
```




